# PROJECT CONTEXT - Example: Node Web API

> Example `PROJECT_CONTEXT.md` generated by the Project Context Cartographer for a simple Node.js Express REST API.

---

## [SECTION:IDENTITY] Project Identity & Stack

- **Project Name:** Acme Orders API
- **Short Description:** A Node.js/Express REST API for managing customer orders, products, and inventory.
- **Primary Repository Location / URL:** `git@github.com:acme-inc/orders-api.git`
- **Primary Project Type:** `web_api`
- **Primary Language & Runtime:** Node.js 20
- **Primary Framework(s):** Express 4.19
- **Package Manager / Build Tool:** pnpm
- **Primary Entry Point(s):**
  - `src/server.ts`
  - `src/index.ts`
- **Runtime Targets (environments):**
  - Development: `docker-compose up api`
  - Staging: Kubernetes deployment `orders-api-staging`
  - Production: Kubernetes deployment `orders-api`

### 1.1 Primary Responsibilities

- Expose REST endpoints for CRUD operations on orders, products, and customers.
- Coordinate persistence to a PostgreSQL database and cache reads via Redis.
- Emit domain events to a message queue for downstream analytics and billing.

### 1.2 High-Level Capabilities

- Token-based authentication and authorization using JWT.
- Paginated, filterable listing of orders and products.
- Basic health and readiness probes for Kubernetes.

---

## [SECTION:STRUCTURE] Directory Layout & Key Statistics

### 2.1 Directory Overview

```text
.
├── src/
│   ├── config/
│   ├── routes/
│   ├── controllers/
│   ├── services/
│   ├── models/
│   └── infrastructure/
├── tests/
├── frontend/
├── docker/
└── scripts/
```

### 2.2 Key Paths

- **Source Roots:** `src/`
- **Test Roots:** `tests/`, `src/__tests__/`
- **Configuration & Manifests:** `package.json`, `tsconfig.json`, `pnpm-lock.yaml`, `docker-compose.yml`, `k8s/`
- **Infrastructure / Deployment:** `docker/`, `k8s/`
- **Documentation:** `README.md`, `docs/architecture.md`

### 2.3 Repository Statistics

| Metric                              | Value |
|-------------------------------------|-------|
| Total files (excluding ignores)     | ~180  |
| Source files (primary language)     | ~90   |
| Test files                          | ~40   |
| Config / manifest files             | ~12   |
| Approx LOC (primary language)       | ~8,000 |
| Approx LOC (other languages)        | ~3,000 (TS/React frontend) |

---

## [SECTION:DEPENDENCIES] Dependencies & System Requirements

### 3.1 Runtime & Platform Requirements

- **Runtime(s):** Node.js 20.x
- **Minimum Version(s):** `>=20.0.0`
- **Supported OS / Architectures:** Linux x86_64 (tested on Ubuntu-based Docker images)

### 3.2 Application Dependencies (Production)

| Name           | Version   | Type / Role                 | Notes                          |
|----------------|-----------|-----------------------------|--------------------------------|
| express        | ^4.19.0   | HTTP server / routing       | Core framework                 |
| pg             | ^8.11.0   | PostgreSQL driver           | Database connectivity          |
| typeorm        | ^0.3.x    | ORM / data mapping          | Models and migrations          |
| jsonwebtoken   | ^9.0.0    | Auth / JWT handling         | Access token verification      |
| ioredis        | ^5.x      | Redis client                | Caching for hot reads          |

### 3.3 Development & Tooling Dependencies

| Name           | Version   | Category (test, lint, build) | Notes                     |
|----------------|-----------|------------------------------|---------------------------|
| typescript     | ^5.x      | build                        | Type checking / TS build  |
| jest           | ^29.x     | test                         | Unit / integration tests  |
| ts-jest        | ^29.x     | test                         | Jest + TS integration     |
| eslint         | ^8.x      | lint                         | Linting                   |
| prettier       | ^3.x      | formatting                   | Code formatting           |

### 3.4 External Runtime Requirements

- Docker (for local and production container builds).
- Access to managed PostgreSQL and Redis instances.

---

## [SECTION:ARCHITECTURE] Architecture & Components

### 4.1 Overall Architecture Style

- **Architecture Style (Inference):** Layered architecture (API → services → repositories → database).
  - Inference: presence of `routes/`, `controllers/`, `services/`, `models/`, and `infrastructure/` directories.

### 4.2 Modules / Layers

| Layer / Module      | Purpose                                    | Key Directories / Files           |
|---------------------|--------------------------------------------|-----------------------------------|
| Presentation / API  | HTTP endpoints, request/response mapping   | `src/routes/`, `src/controllers/` |
| Domain / Services   | Business logic, orchestration              | `src/services/`                   |
| Data Access / Repos | Database access, query definitions         | `src/models/`, `src/infrastructure/repositories/` |
| Cross-Cutting       | Logging, config, auth, error handling      | `src/config/`, `src/infrastructure/` |

### 4.3 Core Components

- `OrderController` - `src/controllers/order-controller.ts` - maps HTTP requests to service calls.
- `OrderService` - `src/services/order-service.ts` - encapsulates order-related business rules.
- `OrderRepository` - `src/infrastructure/repositories/order-repository.ts` - reads/writes orders in PostgreSQL.

---

## [SECTION:DATA_MODEL] Data Model & Storage

### 5.1 Storage Technologies

- **Primary Database:** PostgreSQL 14
- **Other Stores:** Redis (caching)

### 5.2 Key Entities / Tables

| Entity / Table | Storage Type | Location (file / path)                 | Notes / Relationships           |
|----------------|-------------|----------------------------------------|---------------------------------|
| Order          | SQL (orders)| `src/models/order.entity.ts`          | References Customer and Product |
| Customer       | SQL         | `src/models/customer.entity.ts`       | One-to-many with Order          |
| Product        | SQL         | `src/models/product.entity.ts`        | Many-to-many with Order via join table |

### 5.3 Relationships (High-Level)

- `Customer (1) - (many) Order`
- `Order (many) - (many) Product` via `order_products` join table.

---

## [SECTION:APIS] Public Interfaces & API Surface

### 6.1 HTTP APIs

| Method | Path                     | Handler / Location                       | Auth? | Description                      |
|--------|--------------------------|------------------------------------------|-------|----------------------------------|
| GET    | `/health`                | `HealthController.getHealth`             | No    | Liveness / readiness probe       |
| GET    | `/orders`                | `OrderController.listOrders`             | Yes   | List orders with filters         |
| POST   | `/orders`                | `OrderController.createOrder`            | Yes   | Create a new order               |
| GET    | `/orders/:id`            | `OrderController.getOrderById`           | Yes   | Retrieve order details           |

### 6.2 CLI Commands

Not documented (reason: no CLI entry points found).

### 6.3 Library Surface

Not documented (reason: project is a web API, not a library).

---

## [SECTION:INTEGRATIONS] External Integrations & Services

### 7.1 Third-Party Services

| Service / Provider | Type (REST, SDK, message) | Purpose                  | Where Configured                |
|--------------------|---------------------------|--------------------------|---------------------------------|
| Stripe             | REST SDK                  | Payment processing       | `src/infrastructure/payments/`  |

### 7.2 Internal Services & Messaging

| Integration        | Protocol (HTTP, gRPC, MQ) | Direction (in/out)       | Notes                           |
|--------------------|---------------------------|--------------------------|---------------------------------|
| Events topic       | MQ (Kafka)                | Outbound                 | Emits order-created events      |

---

## [SECTION:CONFIG] Configuration & Environment

### 8.1 Configuration Files

- `src/config/config.ts` - central application config loader.
- `config/default.json` - non-secret defaults (ports, feature flags).

### 8.2 Environment Variables (Templates Only)

| Name                 | Required? | Default / Example (non-secret) | Purpose                         |
|----------------------|----------:|--------------------------------|---------------------------------|
| `NODE_ENV`           |       yes | `development`                  | Controls environment behavior   |
| `PORT`               |       no  | `3000`                         | HTTP listen port                |
| `DATABASE_URL`       |       yes | (redacted)                     | PostgreSQL connection string    |
| `REDIS_URL`          |       no  | (redacted)                     | Redis connection URL            |

### 8.3 Feature Flags & Modes

- `ORDERS_READ_FROM_CACHE` - enables Redis-backed reads for hot endpoints.

---

## [SECTION:WORKFLOWS] Critical Workflows

### 9.1 Workflow: Create Order

**Goal:** Persist a new order and emit a domain event.

**Entry Point:** `POST /orders`

**Step-by-step Flow:**
1. `OrderController.createOrder` validates the request body using schema validation.
2. `OrderService.createOrder` builds the domain model and calls the repository.
3. `OrderRepository.save` inserts records into `orders` and join tables.
4. `OrderService` publishes an `order.created` event to Kafka.

**Data Involved:** `Order`, `Customer`, `Product` entities.

**External Calls:** PostgreSQL, Kafka.

**Error Handling:** Transaction rollback on DB errors; 4xx for validation errors; 5xx logged with correlation ID.

---

## [SECTION:OPERATIONS] Deployment, Operations & Testing

### 10.1 Build & Run (Development)

- Install dependencies: `pnpm install`
- Run tests: `pnpm test`
- Start dev server: `pnpm dev`

### 10.2 Build & Run (Production)

- Build image: `docker build -t acme/orders-api .`
- Deploy to Kubernetes using manifests in `k8s/`.

### 10.3 CI / CD Pipelines

- GitHub Actions workflow in `.github/workflows/ci.yml`:
  - Install → lint → test → build → push Docker image.

### 10.4 Testing Strategy

| Test Type      | Tools / Frameworks     | Location / Pattern            | Notes                          |
|----------------|------------------------|-------------------------------|--------------------------------|
| Unit           | Jest + ts-jest         | `src/**/__tests__/*.test.ts` | Fast, isolated tests           |
| Integration    | Jest + test containers | `tests/integration/**/*.test.ts` | DB + Redis + Kafka in Docker |
| End-to-end     | Not documented         |                               |                                |

---

## [SECTION:RISKS] Known Issues, Gaps & TODOs

### 11.1 Known Issues

- Long-running queries for large order history; no pagination on some endpoints.

### 11.2 Gaps in Documentation / Context

- No formal SLA or performance targets documented.

### 11.3 Future Improvements

- Introduce rate limiting on write-heavy endpoints.
- Add OpenAPI/Swagger spec and publish it in CI.

