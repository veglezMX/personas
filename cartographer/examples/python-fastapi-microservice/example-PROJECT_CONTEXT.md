# PROJECT CONTEXT – Example: Python FastAPI Microservice

> Example `PROJECT_CONTEXT.md` generated by the Project Context Cartographer for a Python FastAPI microservice.

---

## [SECTION:IDENTITY] Project Identity & Stack

- **Project Name:** Billing Events Service
- **Short Description:** A FastAPI-based microservice that ingests billing-related events and exposes reporting APIs.
- **Primary Repository Location / URL:** `git@github.com:acme-inc/billing-events-service.git`
- **Primary Project Type:** `microservice`
- **Primary Language & Runtime:** Python 3.11
- **Primary Framework(s):** FastAPI
- **Package Manager / Build Tool:** Poetry
- **Primary Entry Point(s):**
  - `app/main.py` (FastAPI app factory)
  - `app/__main__.py`
- **Runtime Targets (environments):**
  - Development: Docker Compose
  - Staging: Kubernetes namespace `billing-stg`
  - Production: Kubernetes namespace `billing-prod`

### 1.1 Primary Responsibilities

- Receive billing-related events over HTTP.
- Persist normalized event data to PostgreSQL.
- Expose read-only APIs for billing reports and audit views.

### 1.2 High-Level Capabilities

- Event ingestion with schema validation via Pydantic.
- Filterable reporting endpoints for finance teams.
- Health and readiness endpoints for orchestration.

---

## [SECTION:STRUCTURE] Directory Layout & Key Statistics

### 2.1 Directory Overview

```text
.
├── app/
│   ├── api/
│   │   ├── v1/
│   │   └── dependencies/
│   ├── core/
│   ├── models/
│   ├── schemas/
│   ├── db/
│   │   └── migrations/
│   └── services/
├── tests/
├── infra/
└── web/
```

### 2.2 Key Paths

- **Source Roots:** `app/`
- **Test Roots:** `tests/`, `app/tests/`
- **Configuration & Manifests:** `pyproject.toml`, `alembic.ini`, `Dockerfile`, `docker-compose.yml`
- **Infrastructure / Deployment:** `infra/` (Terraform, K8s manifests)
- **Documentation:** `README.md`, `docs/`

### 2.3 Repository Statistics

| Metric                              | Value |
|-------------------------------------|-------|
| Total files (excluding ignores)     | ~120  |
| Source files (primary language)     | ~70   |
| Test files                          | ~30   |
| Config / manifest files             | ~10   |
| Approx LOC (primary language)       | ~6,000 |
| Approx LOC (other languages)        | ~1,500 (frontend + infra) |

---

## [SECTION:DEPENDENCIES] Dependencies & System Requirements

### 3.1 Runtime & Platform Requirements

- **Runtime(s):** Python 3.11
- **Minimum Version(s):** `>=3.11`
- **Supported OS / Architectures:** Linux x86_64 (Docker images based on `python:3.11-slim`)

### 3.2 Application Dependencies (Production)

| Name            | Version   | Type / Role                | Notes                        |
|-----------------|-----------|----------------------------|------------------------------|
| fastapi         | ^0.111.0  | Web framework              | ASGI HTTP API                |
| uvicorn         | ^0.30.0   | ASGI server                | Production entry point       |
| sqlalchemy      | ^2.x      | ORM / DB access            | Async engine, sessionmaker   |
| alembic         | ^1.13.0   | Database migrations        | Schema evolution             |
| pydantic        | ^2.x      | Data validation / parsing  | Request/response schemas     |

### 3.3 Development & Tooling Dependencies

| Name            | Version   | Category (test, lint, build) | Notes                      |
|-----------------|-----------|------------------------------|----------------------------|
| pytest          | ^8.x      | test                         | Unit / integration tests   |
| httpx           | ^0.27.0   | test                         | Async HTTP client for tests|
| mypy            | ^1.x      | type checking                | Optional static typing     |
| ruff            | ^0.5.x    | lint                         | Linting / formatting rules |

### 3.4 External Runtime Requirements

- PostgreSQL 14
- Redis (optional, for caching / rate limiting)

---

## [SECTION:ARCHITECTURE] Architecture & Components

### 4.1 Overall Architecture Style

- **Architecture Style (Inference):** Layered microservice with clear separation of API, domain services, and data access.
  - Inference: directory split into `api/`, `services/`, `models/`, `schemas/`, `db/`.

### 4.2 Modules / Layers

| Layer / Module      | Purpose                                   | Key Directories / Files               |
|---------------------|-------------------------------------------|---------------------------------------|
| API                 | HTTP endpoints, dependency injection      | `app/api/`                            |
| Core / Settings     | Settings, logging, app startup            | `app/core/`                           |
| Domain Services     | Business logic for billing events         | `app/services/`                       |
| Data Access         | ORM models, DB connections, migrations    | `app/models/`, `app/db/`              |

### 4.3 Core Components

- `create_app` – `app/main.py` – FastAPI application factory.
- `BillingEventService` – `app/services/billing_events.py` – core billing event orchestration.
- `BillingEvent` model – `app/models/billing_event.py` – ORM entity representing events.

---

## [SECTION:DATA_MODEL] Data Model & Storage

### 5.1 Storage Technologies

- **Primary Database:** PostgreSQL (via SQLAlchemy + Alembic)

### 5.2 Key Entities / Tables

| Entity / Table | Storage Type | Location (file / path)           | Notes / Relationships                |
|----------------|-------------|----------------------------------|--------------------------------------|
| BillingEvent   | SQL         | `app/models/billing_event.py`   | Links to Account and Invoice records |
| Account        | SQL         | `app/models/account.py`         | One-to-many with BillingEvent        |

### 5.3 Relationships (High-Level)

- `Account (1) — (many) BillingEvent`

---

## [SECTION:APIS] Public Interfaces & API Surface

### 6.1 HTTP APIs

| Method | Path                     | Handler / Location                      | Auth? | Description                         |
|--------|--------------------------|-----------------------------------------|-------|-------------------------------------|
| GET    | `/health`                | `health_router.get_health`             | No    | Liveness / readiness probe          |
| POST   | `/v1/events`             | `events_router.create_event`           | Yes   | Ingest a new billing event          |
| GET    | `/v1/events`             | `events_router.list_events`            | Yes   | Filterable list of events           |

### 6.2 CLI Commands

Not documented (reason: no dedicated CLI entrypoints detected).

### 6.3 Library Surface

Not documented (reason: service is deployed as an HTTP API, not consumed as a library).

---

## [SECTION:INTEGRATIONS] External Integrations & Services

### 7.1 Third-Party Services

| Service / Provider | Type (REST, SDK, message) | Purpose                             | Where Configured          |
|--------------------|---------------------------|-------------------------------------|---------------------------|
| Metrics backend    | SDK                       | Export service metrics              | `app/core/metrics.py`     |

### 7.2 Internal Services & Messaging

| Integration        | Protocol (HTTP, gRPC, MQ) | Direction (in/out)       | Notes                      |
|--------------------|---------------------------|--------------------------|----------------------------|
| Ledger service     | HTTP                      | Outbound                 | Lookups for account status |

---

## [SECTION:CONFIG] Configuration & Environment

### 8.1 Configuration Files

- `app/core/config.py` – Pydantic-based settings model (reads env vars).
- `alembic.ini` – Alembic migrations configuration.

### 8.2 Environment Variables (Templates Only)

| Name                       | Required? | Default / Example (non-secret) | Purpose                              |
|----------------------------|----------:|--------------------------------|--------------------------------------|
| `ENVIRONMENT`              |       yes | `local`                        | Environment name                     |
| `DATABASE_URL`             |       yes | (redacted)                     | PostgreSQL connection string         |
| `REDIS_URL`                |       no  | (redacted)                     | Redis connection URL                 |
| `METRICS_BACKEND_URL`      |       no  | (redacted)                     | Metrics exporter endpoint            |

### 8.3 Feature Flags & Modes

- `ENABLE_ASYNC_BULK_INSERT` – toggles async bulk writes for high-volume ingestion.

---

## [SECTION:WORKFLOWS] Critical Workflows

### 9.1 Workflow: Ingest Billing Event

**Goal:** Accept an inbound billing event and persist it for downstream reporting.

**Entry Point:** `POST /v1/events`

**Step-by-step Flow:**
1. Request is validated by Pydantic schema in `app/schemas/events.py`.
2. `BillingEventService` enriches the event (e.g. lookups from ledger service).
3. ORM model is created and persisted via SQLAlchemy session.
4. Optional metrics and logs are emitted for observability.

**Data Involved:** `BillingEvent`, `Account`.

**External Calls:** Ledger service (HTTP), metrics backend.

**Error Handling:** Validation errors map to 422 responses; database errors return 500 with correlation ID.

---

## [SECTION:OPERATIONS] Deployment, Operations & Testing

### 10.1 Build & Run (Development)

- Install dependencies: `poetry install`
- Run tests: `poetry run pytest`
- Start dev server: `poetry run uvicorn app.main:app --reload`

### 10.2 Build & Run (Production)

- Build Docker image using `Dockerfile`.
- Deploy via Kubernetes manifests under `infra/` (deployment, service, configmap, secret).

### 10.3 CI / CD Pipelines

- GitHub Actions workflow:
  - Lint and type check.
  - Run tests.
  - Build and push Docker image.

### 10.4 Testing Strategy

| Test Type      | Tools / Frameworks     | Location / Pattern              | Notes                        |
|----------------|------------------------|---------------------------------|------------------------------|
| Unit           | pytest                 | `tests/unit/**.py`             | Fast unit-level tests        |
| Integration    | pytest + docker-compose| `tests/integration/**.py`      | DB + external services       |

---

## [SECTION:RISKS] Known Issues, Gaps & TODOs

### 11.1 Known Issues

- No rate limiting; high-volume ingestion could overload the service.

### 11.2 Gaps in Documentation / Context

- No formal SLOs or error budget definitions.

### 11.3 Future Improvements

- Add OpenAPI schema publishing and client generation.
- Implement idempotency keys for event ingestion endpoints.

